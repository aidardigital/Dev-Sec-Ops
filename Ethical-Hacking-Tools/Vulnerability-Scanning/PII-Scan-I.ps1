Scan SharePoint Site for Sensitive Personal Data ScanViaPnPSearch.ps1 1. #Parameters 2. $DateStr = (Get-Date).ToString("yyMMdd"); 3. #$SiteUrl = "https://company.sharepoint.com/sites/department" 4. $SiteUrl = Read-Host -Prompt 'Enter the site URL to scan' 5. $SearchQuery = '(((банк) NEAR(3) (карт)) OR ((водител) NEAR(3) (права)) OR ((medical) -(clinic OR point OR facility)) OR (driver NEAR(3) license) OR (contractor NEAR(3) rate) OR ((cv) -(cvx OR mcv OR cvh OR cvep OR cvr)) OR (credit NEAR(3) card) OR (кредит NEAR(3) карт) OR ((pmp) -(wpmp OR -pmp- OR hpmp OR swprpmp OR pmp-su OR pmp-dg OR pmp-ds)) OR ((passport) -(pipeline OR cooler OR template OR valve OR pump OR quality OR project OR container OR compile OR tech OR mgk OR crane OR compiled OR tank OR piping OR hoist OR boiler OR psv OR operation)) OR ((паспорт) -(тех OR камаз OR типовой OR машин OR msds OR качеств OR эксквататор OR форма OR оборудов OR проект OR безопасност OR кран OR автомат OR реестровый OR строи OR сосуд OR резервуар)) OR resume OR visa OR password OR salary OR militiary OR child OR nationality OR birth OR criminal OR disciplinary OR spous OR пудр OR резюме OR виза OR удостоверени OR медицин OR парол OR зарплат OR военн OR дет OR ребенок OR национальност OR рождени OR криминал OR дисциплинар OR супруг OR investigation OR cardholder OR citizenship OR расследовани OR иин OR "national id" OR "government id" OR "personal email" OR "home address" OR "домашний адрес" OR (((личн) OR (персональн)) NEAR ((имейл) OR "почтовый адрес"))) IsDocument:"True" Path:' + $SiteURL 6. #$CSVFile = ".\SP-PSD-SCAN-$DateStr.csv" 7. $CSVFile = ".\SP-SPD-SCAN.csv" 8. #Connect to PnP Online 9. Connect-PnPOnline -Url $SiteUrl -UseWebLogin 10. #Execute Search 11. $SearchResults = Submit-PnPSearchQuery -Query $SearchQuery -All -TrimDuplicates $False -SelectProperties Filename, Author, Size, ListItemID, LastModifiedTime, ModifiedBy, CreatedBy 12. #Collect Data from search results 13. $Results = @() 14. ForEach ($ResultRow in $SearchResults.ResultRows) 15. { 16. $Results += [pscustomobject] @{ a. Filename = $ResultRow["Filename"] b. Author = $ResultRow["Author"] c. Size = $ResultRow["Size"] d. LastModified = $ResultRow["LastModifiedTime"] i. LastModifiedBy = $ResultRow["ModifiedBy"] ii. CreatedBy = $ResultRow["CreatedBy"] e. ListItemID = $ResultRow["ListItemID"] f. ParentFolder = $ResultRow["ParentLink"] g. URL = $ResultRow["Path"] 17. } 18. } 19. #$Results 20. #Export results to CSV 21. $Results | Export-Csv -Path $CSVFile -NoTypeInformation

Instructions:
1) Download the scan script: ScanViaPnPSearch.ps1 from the shared location of SharePoint Sensitive Personal Data Scan
2) Run PowerShell on your computer: Click on Start button -> Type “PowerShell” -> Click on “Windows PowerShell” app
3) In PowerShell command line, navigate to the location in your computer where you’ve downloaded the scan script: cd
4) Ensure that SharePointPnPPowerShellOnline module has been installed on your computer by running the following command: Install-Module SharePointPnPPowerShellOnline -Scope CurrentUser. Type Y, press Enter, confirm prompt.
5) Once the module is installed, run the scan script by typing the following command: .\ScanViaPnPSearch.ps1, type URL.
6) When scanning completes, a CSV file (named SP-SPD-SCAN.csv) is created at the same location as the scan script.
7) The scan script output file contains the SharePoint Sensitive Personal Data scan results and can be opened in MS Excel
